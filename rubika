from re import findall
from rubika import Bot
from datetime import datetime
import random

bot = Bot("cat",auth="zbsjxqonbogusfkpmqcbrtmygfcfsuiz")
target = "g0wK7B06a5d01db497444264c7199f44"


def hasInsult(msg):
	swData = [False,None]
	return swData

def hasAds(msg):
	links = list(map(lambda ID: ID.strip()[1:],findall("@[\w|_|\d]+", msg))) + list(map(lambda link:link.split("/")[-1],findall("rubika\.ir/\w+",msg)))
	joincORjoing = "joing" in msg or "joinc" in msg

	if joincORjoing: return joincORjoing
	else:
		for link in links:
			try:
				Type = bot.getInfoByUsername(link)["data"]["chat"]["abs_object"]["type"]
				if Type == "Channel":
					return True
			except KeyError: return False

# static variable
answered, sleeped, retries = [], False, {}
q=1
if q==1:
	bot.sendMessage(target,"Ú¯Ø±Ø¨Ù‡ Ú©ÙˆÚ†ÙˆÙ„Ùˆ Ø§ÙˆÙ…Ø¯")
while True:
	try:
		admins = [i["member_guid"] for i in bot.getGroupAdmins(target)["data"]["in_chat_members"]]
		min_id = bot.getGroupInfo(target)["data"]["chat"]["last_message_id"]

		while True:
			try:
				messages = bot.getMessages(target,min_id)
				break
			except:
				continue

		open("id.txt","w").write(str(messages[-1].get("message_id")))

		for msg in messages:
			if msg["type"]=="Text" and not msg.get("message_id") in answered:
				if not sleeped:
					if hasInsult(msg.get("text"))[0] and not msg.get("author_object_guid") in admins :
						#ID = loads(c.decrypt(getUserInfo(msg.get("author_object_guid")).json().get("data_enc"))).get("data").get("user").get("username")
						#sendMessage(guid, f"#Ø§Ø®Ø·Ø§Ø± @{ID}", msg["message_id"])
						bot.deleteMessages(target, [str(msg.get("message_id"))])

					elif hasAds(msg.get("text")) and not msg.get("author_object_guid") in admins :
						bot.deleteMessages(target, [str(msg.get("message_id"))])

					elif "forwarded_from" in msg.keys() and bot.getMessagesInfo(target, [msg.get("message_id")])[0]["forwarded_from"]["type_from"] == "Channel" and not msg.get("author_object_guid") in admins :
						bot.deleteMessages(target, [str(msg.get("message_id"))])
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

					elif msg.get("text") == "Ø³Ú©ÙˆØª" and msg.get("author_object_guid") in admins :
						sleeped = True
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

					elif msg.get("text") == "Ø­Ø°Ù" and msg.get("author_object_guid") in admins :
						bot.deleteMessages(target, [msg.get("reply_to_message_id")])
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

					elif msg.get("text").startswith("Ø¨Ù†") and msg.get("author_object_guid") in admins :
						try:
							guid = bot.getInfoByUsername(msg.get("text").split(" ")[1][1:])["data"]["chat"]["abs_object"]["object_guid"]
							if not guid in admins :
								bot.banGroupMember(target, guid)
								bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))
							else :
								bot.sendMessage(target, "â", message_id=msg.get("message_id"))
								
						except IndexError:
							bot.banGroupMember(target, bot.getMessagesInfo(target, [msg.get("reply_to_message_id")])[0]["author_object_guid"])
							bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

					elif msg.get("text").startswith("send") :
						bot.sendMessage(bot.getInfoByUsername(msg.get("text").split(" ")[1][1:])["data"]["chat"]["object_guid"], " ÛŒÚ© Ù¾ÛŒØ§Ù… Ø¯Ø§Ø±Ù… Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø¯ÙˆØ³Øª Ø¹Ø²ÛŒØ²: \n"+" ".join(msg.get("text").split(" ")[2:]))
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

					elif msg.get("text").startswith("add") :
						bot.invite(target, [bot.getInfoByUsername(msg.get("text").split(" ")[1][1:])["data"]["chat"]["object_guid"]])
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))
					elif msg.get("author_object_guid") in "u0DjMcf04fec2b6a7a8d1b8038ce7310":
						replay="null"
					elif msg.get("text").startswith("Ú†Ø±Ø§") :
						bot.sendMessage(target, f"Ù†Ù…Ø¯ÙˆÙ†Ù…:(", message_id=msg["message_id"])
					elif msg.get("text").startswith("Ø¨Ù…ÛŒØ±") :
						bot.sendMessage(target, f"Ù†Ù‡Ù‡Ù‡Ù‡", message_id=msg["message_id"])
					elif msg.get("text").startswith("Ú¯Ø¯Ø±ØªÙ…Ù†Ø¯ Ú©ÛŒÙ‡") :
						bot.sendMessage(target, f"Ù…Ù†Ù…", message_id=msg["message_id"])
					
					elif msg.get("text").startswith("Ø³Ù„Ø§Ù…") :
						bot.sendMessage(target, f"Ø³Ù„Ø§Ù… Ø®ÙˆØ¨ÛŒ:)", message_id=msg["message_id"])
					elif msg.get("text").startswith("Ø¢ÙØ±ÛŒÙ†") :
						bot.sendMessage(target, f":)", message_id=msg["message_id"])
					elif msg.get("text").startswith("Ù…Ø§Ù…Ø§Ù†Øª Ú©ÛŒÙ‡") :
						bot.sendMessage(target, f"Ù…Ø§Ù…Ø§Ù† Ù…Ø§Ø±ÛŒØ§ Ø¬ÙˆÙ†", message_id=msg["message_id"])
				
					elif msg.get("text").startswith("Ø§Ø³Ù…Øª Ú†ÛŒÙ‡") :
						bot.sendMessage(target, f"Ú¯Ø±Ø¨Ù‡", message_id=msg["message_id"])
				
					elif msg.get("text").startswith("Ø³Ø§Ø¹Øª") :
						time= str(datetime.now())
						bot.sendMessage(target, time, message_id=msg["message_id"])
					elif msg.get("text").startswith("ØªØ§ÛŒÙ…") :
						time= str(datetime.now())
						bot.sendMessage(target, time, message_id=msg["message_id"])
					elif msg.get("text") == "lock" :
						print(bot.setMembersAccess(target, ["ViewMembers","ViewAdmins","AddMember"]).text)
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

					elif msg.get("text") == "unlock" :
						bot.setMembersAccess(target, ["ViewMembers","ViewAdmins","SendMessages","AddMember"])
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

				else:
					if msg.get("text") == "!wakeup" and msg.get("author_object_guid") in admins :
						sleeped = False
						bot.sendMessage(target, "âœ“", message_id=msg.get("message_id"))

			elif msg["type"]=="Event" and not msg.get("message_id") in answered and not sleeped:
				name = bot.getGroupInfo(target)["data"]["group"]["group_title"]
				data = msg['event_data']
				if data["type"]=="RemoveGroupMembers":
					user = bot.getUserInfo(data['peer_objects'][0]['object_guid'])["data"]["user"]["first_name"]
					bot.sendMessage(target, f"Ø¨Ø§ÛŒ Ø¨Ø§ÛŒ {user} ğŸ‘‹", message_id=msg["message_id"])
				
				elif data["type"]=="AddedGroupMembers":
					user = bot.getUserInfo(data['peer_objects'][0]['object_guid'])["data"]["user"]["first_name"]
					bot.sendMessage(target, f"Ø³Ù„Ø§Ù… {user} Ø¹Ø²ÛŒØ² Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ {name} Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ˜ƒ", message_id=msg["message_id"])
			
				elif data["type"]=="LeaveGroup":
					user = bot.getUserInfo(data['performer_object']['object_guid'])["data"]["user"]["first_name"]
					bot.sendMessage(target, f"Ø¨Ø§ÛŒ Ø¨Ø§ÛŒ {user} ", message_id=msg["message_id"])
					
				elif data["type"]=="JoinedGroupByLink":
					user = bot.getUserInfo(data['performer_object']['object_guid'])["data"]["user"]["first_name"]
					bot.sendMessage(target, f"Ø³Ù„Ø§Ù… {user} Ø¹Ø²ÛŒØ² Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ {name} Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸ˜ƒ", message_id=msg["message_id"])

			answered.append(msg.get("message_id"))

	except KeyboardInterrupt:
		exit()

	except Exception as e:
		if type(e) in list(retries.keys()):
			if retries[type(e)] < 3:
				retries[type(e)] += 1
				continue
			else:
				retries.pop(type(e))
		else:
			retries[type(e)] = 1
			continue
